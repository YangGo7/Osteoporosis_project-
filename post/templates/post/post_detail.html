{% extends 'base.html' %}

{% block explain_contents %}
<div class="card p-4 shadow-sm">
    <h2 class="mb-2">{{ post.title }}</h2>
    <p class="text-muted">ì‘ì„±ì: {{ post.author.username }} | {{ post.created_at|date:"Y-m-d H:i" }}</p>
    <hr>
    <p>{{ post.content }}</p>
</div>

<!-- ì „ì²´ ë²„íŠ¼ ì˜ì—­ -->
<div class="d-flex justify-content-end align-items-center flex-wrap gap-2 my-4 px-2">
    {% if user.is_authenticated %}
        <button id="like-btn" data-post-id="{{ post.id }}"
                class="btn btn-sm mt-1 me-3
                {% if user in post.likes.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                style="width: auto; display: inline-block; transition: 0.3s ease;">
            {% if user in post.likes.all %}
                â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
            {% else %}
                ğŸ¤ ì¢‹ì•„ìš”
            {% endif %}
            (<span id="like-count">{{ post.likes.count }}</span>)
        </button>
    {% endif %}

    {% if post.author == user %}
    <a href="{% url 'edit_post' post.id %}" class="btn btn-sm btn-warning text-center" style="width: 100px;">
        âœï¸ ìˆ˜ì •
    </a>
    <form method="POST" action="{% url 'delete_post' post.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-danger text-center" style="width: 100px;">
            âŒ ì‚­ì œ
        </button>
    </form>
{% endif %}

{% if can_reply %}
    <a href="{% url 'create_reply' post.id %}" class="btn btn-sm btn-primary text-center" style="width: 100px;">
        ğŸ’¬ ë‹µë³€
    </a>
{% endif %}
</div>


<!-- âœ… ëŒ“ê¸€(ë‹µë³€) ë¦¬ìŠ¤íŠ¸ + ì¢‹ì•„ìš” ë²„íŠ¼ ì •ë¦¬ -->
{% for reply in replies %}
    <div class="card p-3 mt-3 {% if reply.is_secret and user != post.author %}bg-light{% endif %}">
        {% if post.is_secret and reply.is_secret and user != post.author %}
            <p class="text-muted">ğŸ”’ ë¹„ë°€ ë‹µë³€ì…ë‹ˆë‹¤.</p>
        {% else %}
            <p>{{ reply.content }}</p>
            <p class="text-muted mb-2">- {{ reply.author.username }}</p>

            {% if user.is_authenticated %}
                <div class="text-end">
                    <button class="btn btn-sm reply-like-btn mt-1 
                                   {% if user in reply.likes.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                            data-reply-id="{{ reply.id }}"
                            style="width: auto; display: inline-block; transition: 0.3s ease;">
                        {% if user in reply.likes.all %}
                            â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
                        {% else %}
                            ğŸ¤ ì¢‹ì•„ìš”
                        {% endif %}
                        (<span class="reply-like-count">{{ reply.likes.count }}</span>)
                    </button>
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endfor %}

<!-- ğŸ”™ ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ - ì¤‘ì•™ ì •ë ¬ -->
<div class="text-center mt-5">
    <a href="{% url 'board' %}" class="btn btn-secondary px-4 py-2">ëª©ë¡ìœ¼ë¡œ</a>
</div>

<!-- ğŸ”¥ ì¢‹ì•„ìš” ê¸°ëŠ¥ìš© ìŠ¤í¬ë¦½íŠ¸ (ê²Œì‹œê¸€ + ëŒ“ê¸€) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ê²Œì‹œê¸€ ì¢‹ì•„ìš”
    const postLikeBtn = document.getElementById("like-btn");
    if (postLikeBtn) {
        postLikeBtn.addEventListener("click", function () {
            const postId = this.dataset.postId;
            fetch(`/post/${postId}/like/`)
                .then(response => response.json())
                .then(data => {
                    postLikeBtn.innerHTML = data.liked
                        ? `â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ (<span id='like-count'>${data.like_count}</span>)`
                        : `ğŸ¤ ì¢‹ì•„ìš” (<span id='like-count'>${data.like_count}</span>)`;

                    postLikeBtn.classList.toggle("btn-outline-danger", !data.liked);
                    postLikeBtn.classList.toggle("btn-danger", data.liked);
                });
        });
    }

    // ëŒ“ê¸€ ì¢‹ì•„ìš”
    const replyLikeBtns = document.querySelectorAll(".reply-like-btn");
    replyLikeBtns.forEach(btn => {
        btn.addEventListener("click", function () {
            const replyId = this.dataset.replyId;
            fetch(`/post/reply/${replyId}/like/`)
                .then(response => response.json())
                .then(data => {
                    // ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ + ìˆ˜ ì—…ë°ì´íŠ¸
                    this.innerHTML = data.liked
                        ? `â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ (<span class='reply-like-count'>${data.like_count}</span>)`
                        : `ğŸ¤ ì¢‹ì•„ìš” (<span class='reply-like-count'>${data.like_count}</span>)`;

                    // í´ë˜ìŠ¤ í† ê¸€
                    this.classList.toggle("btn-outline-danger", !data.liked);
                    this.classList.toggle("btn-danger", data.liked);
                });
        });
    });
});
</script>
{% endblock %}
